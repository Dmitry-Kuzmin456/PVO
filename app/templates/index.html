<!DOCTYPE html>
<html>
<head>
    <title>AD Missile Simulation</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; background: #f0f2f5; }
        .container { display: flex; gap: 20px; }
        .controls { width: 300px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .visual { flex-grow: 1; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #graph { width: 100%; height: 700px; }
        .stat-box { margin-top: 20px; padding: 10px; background: #eef; border-radius: 4px; }
        button { width: 100%; padding: 10px; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; margin-top: 20px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; }
    </style>
</head>
<body>
    <h1>Моделирование траектории ПВО</h1>
    <div class="container">
        <div class="controls">
            <h3>Параметры ветра</h3>
            <label>Скорость (м/с): <span id="ws-val">0</span></label>
            <input type="range" id="wind-speed" min="0" max="100" value="0">

            <label>Направление (град): <span id="wd-val">0</span></label>
            <input type="range" id="wind-dir" min="0" max="360" value="0">

            <div class="stat-box">
                <p>Время: <span id="time-disp">0.0</span> с</p>
                <p>Высота ракеты: <span id="alt-disp">0</span> м</p>
                <p>Дистанция: <span id="dist-disp">---</span> м</p>
            </div>
            <button id="start-btn" onclick="startSimulation()">Запуск</button>
        </div>
        <div class="visual">
            <div id="graph"></div>
        </div>
    </div>

    <script>
        let socket;
        let isRunning = false;

        const layout = {
            title: 'Траектория полета',
            scene: {
                // Убираем жесткие границы, чтобы камера следила за объектами
                aspectmode: 'data'
            },
            margin: {l: 0, r: 0, b: 0, t: 30}
        };

        // Инициализируем пустой график
        Plotly.newPlot('graph', [{
            type: 'scatter3d', mode: 'lines+markers', name: 'Ракета',
            x: [0], y: [0], z: [0], marker: {color:'red', size:4}
        }, {
            type: 'scatter3d', mode: 'lines+markers', name: 'Цель',
            x: [2000], y: [5000], z: [3000], marker: {color:'blue', size:4}
        }], layout);

        const wsInput = document.getElementById('wind-speed');
        const wdInput = document.getElementById('wind-dir');

        function updateInputs() {
            document.getElementById('ws-val').innerText = wsInput.value;
            document.getElementById('wd-val').innerText = wdInput.value;
            if (isRunning && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    wind_speed: wsInput.value,
                    wind_dir: wdInput.value
                }));
            }
        }

        wsInput.oninput = updateInputs;
        wdInput.oninput = updateInputs;

        function startSimulation() {
            if (isRunning) return;

            document.getElementById('start-btn').disabled = true;
            isRunning = true;

            // Очищаем графики
            Plotly.restyle('graph', {x: [[0]], y: [[0]], z: [[0]]}, [0]);
            Plotly.restyle('graph', {x: [[2000]], y: [[5000]], z: [[3000]]}, [1]);

            const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            socket = new WebSocket(`${protocol}://${window.location.host}/ws/simulate`);

            // Буферы для накопления точек
            let mX = [0], mY = [0], mZ = [0];
            let tX = [2000], tY = [5000], tZ = [3000];

            socket.onopen = function() {
                socket.send(JSON.stringify({
                    wind_speed: wsInput.value,
                    wind_dir: wdInput.value
                }));
            };

            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);

                document.getElementById('time-disp').innerText = data.time;
                document.getElementById('alt-disp').innerText = Math.round(data.missile[2]);
                document.getElementById('dist-disp').innerText = data.distance;

                mX.push(data.missile[0]);
                mY.push(data.missile[1]);
                mZ.push(data.missile[2]);

                tX.push(data.target[0]);
                tY.push(data.target[1]);
                tZ.push(data.target[2]);

                // Обновляем график
                Plotly.restyle('graph', {
                    x: [mX, tX],
                    y: [mY, tY],
                    z: [mZ, tZ]
                }, [0, 1]);
            };

            socket.onclose = function() {
                isRunning = false;
                document.getElementById('start-btn').disabled = false;
                console.log("Connection closed");
            };
        }
    </script>
</body>
</html>